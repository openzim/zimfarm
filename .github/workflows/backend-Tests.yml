name: Backend Tests

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  # unit-tests:
  #   runs-on: ubuntu-24.04
  #
  #  env:
  #    POSTGRES_URI: nodb

  #  steps:
  #    - name: Retrieve source code
  #      uses: actions/checkout@v4

  #    - name: Set up Python
  #      uses: actions/setup-python@v5
  #      with:
  #        python-version-file: backend/pyproject.toml
  #        architecture: x64
  #
  #    - name: Install dependencies (and project)
  #      working-directory: backend
  #      run: |
  #        pip install -U pip
  #        pip install -e .[lint,scripts,test,check]
  #
  #    - name: Test with pytest
  #      working-directory: backend
  #      run: pytest tests/unit

  run-tests:
    runs-on: ubuntu-24.04

    services:
      postgresdb:
        image: postgres:16.3-bookworm
        env:
          POSTGRES_DB: zimtest
          POSTGRES_PASSWORD: zimpass
          POSTGRES_PORT: 5432
          POSTGRES_USER: zimfarm
        ports:
          - 5432:5432
        # Set health checks to wait until postgresdb has started
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      POSTGRES_URI: postgresql+psycopg://zimfarm:zimpass@localhost:5432/zimtest

    steps:
      - name: Retrieve source code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: backend/pyproject.toml
          architecture: x64

      - name: Install dependencies (and project)
        working-directory: backend
        run: |
          pip install -U pip
          pip install -e .[test,scripts]

      - name: Create extensions on the PostgreSQL database
        run: >-
          psql -c 'CREATE EXTENSION IF NOT EXISTS "uuid-ossp";'
          "host=localhost port=5432 dbname=zimtest user=zimfarm password=zimpass"

      - name: Run tests
        working-directory: backend
        env:
          POSTGRES_URI: postgresql+psycopg://zimfarm:zimpass@localhost:5432/zimtest
          JWT_SECRET: DH8kSxcflUVfNRdkEiJJCn2dOOKI3qfw
        run: pytest -v tests/unit/

      # - name: Upload coverage report to codecov
      #   uses: codecov/codecov-action@v4
      #   with:
      #     directory: backend
      #     fail_ci_if_error: true
      #     token: ${{ secrets.CODECOV_TOKEN }}
