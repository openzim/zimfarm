This is a tentative docker-compose configuration to be used **only** for development purpose.

It is recommended to use it in combination with Mutagen to effeciently sync data from your machine to the Docker containers.

It is still incomplete (not all Zimfarm components are available).

## List of containers

### backend

This container is a backend web server, linked to its database.

### backend-tools

This container is simply a Python stack with all backend requirements but no web server. Context is
setup with appropriate environment variables. Usefull for instance to run alembic.

### backend-tests

This container is simply a Python stack with all backend requirements but no web server. Context is
setup with appropriate environment variables for tests (i.e. it uses the test DB). Usefull to run
tests locally.

### postgresqldb

This container is a PostgreSQL DB. DB data is kept in a volume, persistent across containers restarts.

### mongodb

This container is a Mongo DB.

## Instructions

First start the Docker-Compose stack:
```
cd dev
docker compose -p zimfarm up -d
```

## Setup Postgresql DB

If this is your first run or if you made any schema change, you need to set/update the DB schema

Start a shell in the backend-tools container.
```
docker exec -it zimfarm-backend-tools-1 /bin/sh
```

Once inside the container, ask Alembic to update the schema
```
alembic upgrade head
```

You can also check that everything is ok
```
alembic check
```

Note that to run integration tests, we use a separate DB, you hence have to set/update the DB schema as well.
Just do the same as above with the backend-tests container (instead of the backend-tools)

## Run tests

Do not forget to set/update the test DB schema (see above).

Start a shell in the backend-tests container.
```
docker exec -it zimfarm-backend-tests-1 /bin/sh
```

Once inside the container, run the tests
```
python -m pytest
```

You can select one specific set of tests by path
```
python -m pytest tests/integration/routes/users
```

Or just one specific test function
```
python -m pytest tests/integration/routes/users -k test_list_no_auth
```

### backend database schema

The configuration to generate a schema of the backend database is stored in dispatcher/backend/docs/schemaspy. It is based on a static website generated by SchemaSpy.

To generate DB schema documentation, you can run the following command once your 
docker-compose setup is ready (and supposing that your local DB is up-to-date):

```
cd dispatcher/backend
docker run --network zimfarm_default -v "$(pwd)/docs/schemaspy.properties:/schemaspy.properties" -v "$(pwd)/docs/schemaspy:/output" schemaspy/schemaspy:latest
```